<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fork Join | Java-Concurrent</title>


<link rel="stylesheet" href="/Java-Concurrent/book.min.79de1f7861b0c98f453c0a93bebf3608a280809e417787746c373699639900d7.css">




<link rel="icon" href="/Java-Concurrent/favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://hello-world-example.github.io/Java-Concurrent/">Java-Concurrent</a>
</h2>






    
  
  
  

  <style>
  nav ul a[href$="\2fJava-Concurrent\2f docs\2fjava.util.concurrent\2f ForkJoin\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><strong>java.lang</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.lang/Thread/">Thread</a></li>
<li><a href="/Java-Concurrent/docs/java.lang/ThreadLocal/">ThreadLocal</a></li>
</ul></li>
<li><strong>sun.misc</strong>

<ul>
<li><a href="/Java-Concurrent/docs/sun.misc/Unsafe/">Unsafe</a></li>
</ul></li>
<li><strong>java.util.concurrent.locks</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/locks/LockSupport/">LockSupport</a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/locks/AbstractQueuedSynchronizer/">AbstractQueuedSynchronizer</a></li>
<li><del>ReentrantLock</del></li>
<li><del><sup>[8]</sup>StampedLock</del></li>
</ul></li>
<li><strong>java.util.concurrent</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ExecutorService/">ExecutorService<sup>â™¨</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Future/">Future<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ExecutorCompletionService/">ExecutorCompletionService<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ForkJoin/"><sup>[7]</sup>ForkJoin<sup>â™¨</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CompletableFuture/"><sup>[8]</sup>CompletableFuture<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CountDownLatch/">CountDownLatch <sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Semaphore/">Semaphore<sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CyclicBarrier/">CyclicBarrier<sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Phaser/"><sup>[7]</sup> Phaser<sup>ğŸ”’</sup></a></li>
</ul></li>
<li><strong>java.util.concurrent.atomic</strong>

<ul>
<li><del>AtomicLong</del></li>
<li><del><sup>[8]</sup>LongAdder</del></li>
</ul></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/Java-Concurrent/svg/menu.svg" alt="Menu" />
  </label>
  <strong>Fork Join</strong>
</header>

      
<article class="markdown">

<h1 id="forkjoin">ForkJoin</h1>

<p>ForkJoin æ˜¯ä¸€ä¸ª <strong>åŸºäºåˆ†è€Œæ²»ä¹‹ç®—æ³•</strong>ï¼Œ æŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåï¼Œå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„<strong>æ¡†æ¶</strong>ã€‚æ¡†æ¶åŸºäºä»¥ä¸‹ä¸¤ç§æ“ä½œï¼š</p>

<ul>
<li><strong><code>fork</code> æ“ä½œ</strong>ï¼šæŠŠä»»åŠ¡åˆ†æˆæ›´å°çš„ä»»åŠ¡ï¼Œä½¿ç”¨è¿™ä¸ªæ¡†æ¶æ‰§è¡Œå®ƒä»¬</li>
<li><strong><code>join</code> æ“ä½œ</strong>ï¼šç­‰å¾…åˆ›å»ºçš„ä»»åŠ¡çš„è®¡ç®—ç»“æŸ</li>
</ul>

<p><img src="https://static001.infoq.cn/resource/image/2b/09/2be16e00a8ee6f6c7b738817f003e609.png" alt="https://www.infoq.cn/article/fork-join-introduction" /></p>

<h2 id="ä¸-executor-çš„åŒºåˆ«">ä¸ Executor çš„åŒºåˆ«</h2>

<ul>
<li>Executor æ˜¯æ‰€æœ‰å·¥ä½œçº¿ç¨‹å…¬ç”¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œ<strong>æ‰€æœ‰çš„çº¿ç¨‹æ¶ˆè´¹ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡</strong></li>
<li>ForkJoin æ˜¯ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹æ¶ˆè´¹å„è‡ªä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡</strong></li>
</ul>

<hr />

<ul>
<li>è¿™æ ·çš„è¯ï¼Œ ForkJoin å¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>å‡å¦‚æœ‰äº›ä»»åŠ¡é˜Ÿåˆ—æ—©æ—©è¢«æ¶ˆè´¹å®Œäº†ï¼Œåˆ™è¯¥é˜Ÿåˆ—å¯¹åº”çš„çº¿ç¨‹å°±é—²ç½®äº†</strong></li>
<li><code>Executor</code> åˆ™ä¸ä¼šå‡ºç°è¯¥é—®é¢˜ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå½“çº¿ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œé‡æ–°ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œæ¢æ‰ä¼šé—²ç½®</li>
</ul>

<hr />

<ul>
<li>ForkJoin ä¸ºäº†è§£å†³ä»»åŠ¡é˜Ÿåˆ—æ¶ˆè´¹é€Ÿåº¦ä¸ä¸€è‡´å¯¼è‡´çš„é—²ç½®é—®é¢˜ï¼Œå½“ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œå®Œä¹‹åï¼Œå°±å»å…¶ä»–çº¿ç¨‹çš„é˜Ÿåˆ—é‡Œ<strong>çªƒå–</strong>ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œï¼Œè¿˜ç»™è¿™ä¸ªè¡Œä¸ºèµ·äº†ä¸€ä¸ªé«˜å¤§ä¸Šçš„åå­—ï¼š<strong>å·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ç®—æ³•</strong>ã€‚JDK 1.8 å¯ä»¥ç®€å•çš„é€šè¿‡ <code>ExecutorService executor = Executors.newWorkStealingPool(4)</code> è·å–æ”¹ç±»å‹çš„  <code>Executor</code></li>
<li>è§£å†³äº†çº¿ç¨‹é—²ç½®é—®é¢˜ï¼Œ <code>Executor</code> å’Œ <code>ForkJoin</code> çš„çº¿ç¨‹éƒ½å¯è¾¾åˆ°æ»¡è´Ÿè·è¿è¡Œäº†ï¼Œè¿™æ—¶å€™çš„åŒºåˆ«åœ¨äº<strong>ä¸¤è€…å¯¹æ•°æ®çš„ç«äº‰çŠ¶æ€ä¸ä¸€æ ·</strong>

<ul>
<li><code>Executor</code> å§‹ç»ˆéƒ½æ˜¯æ‰€æœ‰çš„çº¿ç¨‹ç«äº‰ä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®</li>
<li><code>ForkJoin</code> åªæœ‰åœ¨ â€œçªƒå–â€ å…¶ä»–çº¿ç¨‹ä»»åŠ¡é˜Ÿé‡Œçš„æœ€åä¸€æ¡æ•°æ®çš„æ—¶å€™æ‰äº§ç”Ÿç«äº‰</li>
</ul></li>
</ul>

<h2 id="æ ¸å¿ƒç±»">æ ¸å¿ƒç±»</h2>

<ul>
<li><code>ForkJoinPool</code>ï¼šå®ƒå®ç° ExecutorService æ¥å£ å’Œ work-stealing ç®—æ³•ï¼Œç®¡ç†å·¥ä½œçº¿ç¨‹å’Œæä¾›å…³äºä»»åŠ¡çš„çŠ¶æ€å’Œæ‰§è¡Œçš„ä¿¡æ¯</li>
<li><code>ForkJoinTask</code>ï¼š å®ƒæ˜¯æ˜¯åœ¨ ForkJoinPool ä¸­æ‰§è¡Œçš„ä»»åŠ¡çš„åŸºç±»ï¼Œæä¾›åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œ <code>fork()</code> å’Œ <code>join()</code> æ“ä½œçš„æœºåˆ¶ã€‚é€šå¸¸ï¼Œ ä¸ºäº†å®ç°ä½ çš„ Fork/Join ä»»åŠ¡ï¼Œéœ€è¦å®ç° <code>ForkJoinTask</code> çš„å­ç±»

<ul>
<li><code>RecursiveAction</code> å¤„ç†<strong>æ²¡æœ‰è¿”å›å€¼</strong>çš„ä»»åŠ¡</li>
<li><code>RecursiveTask</code> å¤„ç†<strong>æœ‰è¿”å›å€¼</strong>çš„ä»»åŠ¡</li>
</ul></li>
</ul>

<h2 id="ç¼–ç¨‹æµç¨‹">ç¼–ç¨‹æµç¨‹</h2>

<p>ä¸€ä¸ªä½¿ç”¨ ForkJoin æ¡†æ¶ç´¯åŠ çš„ç¤ºä¾‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">class</span> ForkJoinMain {

  <span style="color:#a6e22e">@AllArgsConstructor</span>
  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">class</span> Task <span style="color:#a6e22e">extends</span> RecursiveTask<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">final</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">TASK_SIZE</span> <span style="color:#f92672">=</span> 2;

    List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">data</span>; 
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">start</span>; 
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">end</span>;

    <span style="color:#75715e">/*
</span><span style="color:#75715e">     * éœ€è¦è‡ªå·±å®ç°æ‹†åˆ†å’Œè®¡ç®—é€»è¾‘
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">Integer</span> compute() {
      <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">int</span> taskSize <span style="color:#f92672">=</span> end <span style="color:#f92672">-</span> start;
      <span style="color:#75715e">/*
</span><span style="color:#75715e">       * 2. å½“ä»»åŠ¡å·²ç»æ‹†åˆ†åˆ°äº†æŒ‡å®šçš„é˜€å€¼ï¼Œç›´æ¥ç»“ç®—ç»“æœ
</span><span style="color:#75715e">       */</span>
      <span style="color:#66d9ef">if</span> (taskSize <span style="color:#f92672">&lt;=</span> TASK_SIZE) {
        <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sum</span> <span style="color:#f92672">=</span> 0;
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> start; i <span style="color:#f92672">&lt;</span> end; i<span style="color:#f92672">++</span>) {
          sum <span style="color:#f92672">+=</span> data.<span style="color:#a6e22e">get</span>(i);
        }
        <span style="color:#75715e">// å°æ‰¹ä»»åŠ¡çš„è®¡ç®—ç»“æœ
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> sum;
      }

      <span style="color:#75715e">/*
</span><span style="color:#75715e">       * 1. æ²¡æœ‰æ‹†åˆ†åˆ°äº†æŒ‡å®šçš„é˜€å€¼ï¼Œâ¤â¤â¤ æ‹†åˆ†ä»»åŠ¡ â¤â¤â¤
</span><span style="color:#75715e">       */</span>
      <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">int</span> middle <span style="color:#f92672">=</span> (end <span style="color:#f92672">+</span> start) <span style="color:#f92672">/</span> 2;
      Task <span style="color:#a6e22e">task1</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Task(data, start, middle);
      Task <span style="color:#a6e22e">task2</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Task(data, middle, end);

      <span style="color:#75715e">// task1.fork(); 
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// task2.fork();
</span><span style="color:#75715e"></span>      invokeAll(task1, task2);

      <span style="color:#75715e">/*
</span><span style="color:#75715e">       * 3. â¤â¤ æ±‡æ€»â¤â¤ æ¯ä¸ªå°ä»»åŠ¡çš„ç»“æœ
</span><span style="color:#75715e">       */</span>
      <span style="color:#66d9ef">return</span> task1.<span style="color:#a6e22e">join</span>() <span style="color:#f92672">+</span> task2.<span style="color:#a6e22e">join</span>();
    }
  }

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String[] <span style="color:#a6e22e">args</span>) <span style="color:#66d9ef">throws</span> <span style="color:#a6e22e">InterruptedException</span>, ExecutionException {
    <span style="color:#75715e">// æ•°æ®
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> Arrays.<span style="color:#a6e22e">asList</span>(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);
    <span style="color:#75715e">// ä»»åŠ¡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">Task</span> task <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Task(data, 0, data.<span style="color:#a6e22e">size</span>());

    <span style="color:#75715e">// æäº¤ä»»åŠ¡ æ–¹å¼1
</span><span style="color:#75715e"></span>    Integer <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ForkJoinPool(4).<span style="color:#a6e22e">invoke</span>(task);
    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(result);

    <span style="color:#75715e">// æäº¤ä»»åŠ¡ æ–¹å¼2
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">Future</span><span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">future</span> <span style="color:#f92672">=</span> ForkJoinPool.<span style="color:#a6e22e">commonPool</span>().<span style="color:#a6e22e">submit</span>(task);
    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(future.<span style="color:#a6e22e">get</span>()); <span style="color:#75715e">// è·å–è¿”å›ç»“æœ
</span><span style="color:#75715e"></span>  }
}</code></pre></div>
<p>ä»ä»¥ä¸Šç¤ºä¾‹å¯ä»¥çœ‹å‡ºæ¥</p>

<ul>
<li>ForkJoin åªè´Ÿè´£å¹¶è¡Œæ‰§è¡Œï¼Œ<strong>ä¸è´Ÿè´£å¦‚ä½• æ‹†åˆ†å’Œåˆå¹¶</strong></li>
<li>æ¡†æ¶çš„è®¡ç®—é€»è¾‘éœ€è¦è‡ªå·±å®ç°ï¼ŒåŒ…æ‹¬ <strong>å¦‚ä½•æ‹†åˆ†ä»»åŠ¡</strong> å’Œ <strong>å¦‚ä½•åˆå¹¶ä»»åŠ¡</strong></li>
<li>æ•´ä¸ªæµç¨‹æœ‰ç‚¹ç±»ä¼¼äº Map / Reduce æ¨¡å¼ï¼Œ<strong>å¹¶è¡Œå°æ‰¹é‡è®¡ç®— + æœ€ç»ˆæ±‡æ€»</strong></li>
</ul>

<h2 id="parallelism">parallelism</h2>

<p>ä¸€èˆ¬æ„å»º <code>ForkJoinPool</code>  æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼Œè¿™ä¸ªé‡ç‚¹å…³æ³¨å¹¶è¡Œæ•°ï¼Œç›®çš„æ˜¯<strong>å…³æ³¨åœ¨æ²¡æœ‰CPUé™åˆ¶çš„è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œå‡ºç°çš„å¹¶è¡Œæ•°è¿‡å¤šé—®é¢˜</strong></p>

<h3 id="new-forkjoinpool-parallelism">new ForkJoinPool(parallelism)</h3>

<p>æŒ‡å®šçš„å¤šå°‘å°±æ˜¯å¤šå°‘</p>

<h3 id="new-forkjoinpool">new ForkJoinPool()</h3>

<p>æ„é€ å‡½æ•°ç©ºå‚æ•°ï¼Œ<strong>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¹¶è¡Œæ•°å°±æ˜¯ CPU ä¸ªæ•°</strong></p>

<p>è®¡ç®—æ–¹å¼ <code>Math.min(MAX_CAP, Runtime.getRuntime().availableProcessors()</code>ï¼Œ<code>MAX_CAP</code> = <code>32767</code></p>

<h3 id="forkjoinpool-commonpool">ForkJoinPool.commonPool()</h3>

<ul>
<li>â¤ è¯»å–ç³»ç»Ÿå±æ€§è®¾ç½®çš„ <strong><code>java.util.concurrent.ForkJoinPool.common.parallelism</code></strong> å€¼</li>

<li><p>å¦‚æœæ²¡æœ‰ï¼Œæ˜¯ <code>availableProcessors - 1</code> ä¸ª</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">static</span> ForkJoinPool <span style="color:#a6e22e">makeCommonPool</span>() {
...
    
String <span style="color:#a6e22e">pp</span> <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;java.util.concurrent.ForkJoinPool.common.parallelism&#34;</span>);
<span style="color:#66d9ef">if</span> (pp <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)
parallelism <span style="color:#f92672">=</span> Integer.<span style="color:#a6e22e">parseInt</span>(pp);

...
  
<span style="color:#75715e">// default 1 less than #cores
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (parallelism <span style="color:#f92672">&lt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> (parallelism <span style="color:#f92672">=</span> Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">availableProcessors</span>() <span style="color:#f92672">-</span> 1) <span style="color:#f92672">&lt;=</span> 0)
parallelism <span style="color:#f92672">=</span> 1;
<span style="color:#66d9ef">if</span> (parallelism <span style="color:#f92672">&gt;</span> MAX_CAP)
parallelism <span style="color:#f92672">=</span> MAX_CAP;
  
...
}</code></pre></div></li>
</ul>

<h2 id="å¸¸è§çš„-forkjoin-æ¡ˆä¾‹">å¸¸è§çš„ ForkJoin æ¡ˆä¾‹</h2>

<h3 id="arrays-parallelsort">Arrays.parallelSort</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">static</span> <span style="color:#f92672">&lt;</span>T <span style="color:#a6e22e">extends</span> Comparable<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> <span style="color:#a6e22e">T</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parallelSort</span>(T[] <span style="color:#a6e22e">a</span>) {
  <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> a.<span style="color:#a6e22e">length</span>, p, g;

  <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&lt;=</span> MIN_ARRAY_SORT_GRAN <span style="color:#f92672">||</span> (p <span style="color:#f92672">=</span> ForkJoinPool.<span style="color:#a6e22e">getCommonPoolParallelism</span>()) <span style="color:#f92672">==</span> 1)
    <span style="color:#75715e">// â€œæ•°æ®ä¸ªæ•° &lt;= 8192â€ æˆ– â€œå¹¶è¡Œæ•°åªæœ‰ 1â€ çš„æ—¶å€™ä½¿ç”¨ TimSort ç®—æ³•
</span><span style="color:#75715e"></span>    TimSort.<span style="color:#a6e22e">sort</span>(a, 0, n, NaturalOrder.<span style="color:#a6e22e">INSTANCE</span>, <span style="color:#66d9ef">null</span>, 0, 0);
  <span style="color:#66d9ef">else</span>
    <span style="color:#75715e">// å¦åˆ™ä½¿ç”¨ å¹¶è¡Œæ’åº
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">new</span> ArraysParallelSortHelpers.<span style="color:#a6e22e">FJObject</span>.<span style="color:#a6e22e">Sorter</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(...).<span style="color:#a6e22e">invoke</span>();
}</code></pre></div>
<h3 id="stream-parallel">stream.parallel()</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">final</span> <span style="color:#a6e22e">int</span> sum <span style="color:#f92672">=</span> IntStream.<span style="color:#a6e22e">of</span>(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
        <span style="color:#75715e">// æ ‡è®°å¹¶è¡Œ
</span><span style="color:#75715e"></span>        .<span style="color:#a6e22e">parallel</span>()
        <span style="color:#75715e">// åœ¨æœ€ç»ˆæ“ä½œï¼ˆTerminalï¼‰çš„æ—¶å€™é€‰æ‹© ä¸²è¡Œæˆ–å¹¶è¡Œ æ‰§è¡Œ
</span><span style="color:#75715e"></span>        .<span style="color:#a6e22e">sum</span>();

<span style="color:#66d9ef">final</span> <span style="color:#f92672">&lt;</span>R<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">R</span> evaluate(TerminalOp<span style="color:#f92672">&lt;</span>E_OUT, R<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">terminalOp</span>) {
  ...
  <span style="color:#66d9ef">return</span> isParallel()
    <span style="color:#f92672">?</span> terminalOp.<span style="color:#a6e22e">evaluateParallel</span>(<span style="color:#66d9ef">this</span>, sourceSpliterator(terminalOp.<span style="color:#a6e22e">getOpFlags</span>()))
    <span style="color:#f92672">:</span> terminalOp.<span style="color:#a6e22e">evaluateSequential</span>(<span style="color:#66d9ef">this</span>, sourceSpliterator(terminalOp.<span style="color:#a6e22e">getOpFlags</span>()));
}

<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>P_IN<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">R</span> evaluateSequential(PipelineHelper<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">helper</span>, Spliterator<span style="color:#f92672">&lt;</span>P_IN<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">spliterator</span>){
  <span style="color:#66d9ef">return</span> helper.<span style="color:#a6e22e">wrapAndCopyInto</span>(makeSink(), spliterator).<span style="color:#a6e22e">get</span>();
}

<span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#f92672">&lt;</span>P_IN<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">R</span> evaluateParallel(PipelineHelper<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">helper</span>, Spliterator<span style="color:#f92672">&lt;</span>P_IN<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">spliterator</span>) {
  <span style="color:#75715e">// â¤â¤â¤ ReduceTask
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ReduceTask<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#66d9ef">this</span>, helper, spliterator).<span style="color:#a6e22e">invoke</span>().<span style="color:#a6e22e">get</span>();
}</code></pre></div>
<h2 id="read-more">Read More</h2>

<ul>
<li><a href="https://www.infoq.cn/article/fork-join-introduction">èŠèŠå¹¶å‘ï¼ˆå…«ï¼‰â€”â€”Fork/Join æ¡†æ¶ä»‹ç»</a></li>
<li><a href="https://blog.csdn.net/weixin_41404773/article/details/80733324">RecursiveTask å’Œ RecursiveAction çš„ä½¿ç”¨</a></li>
<li>ifeve Fork/Joinæ¡†æ¶

<ul>
<li><a href="http://ifeve.com/fork-join-1/">Fork/Joinæ¡†æ¶ï¼ˆä¸€ï¼‰å¼•è¨€</a></li>
<li><a href="http://ifeve.com/fork-join-2/">Fork/Joinæ¡†æ¶ï¼ˆäºŒï¼‰åˆ›å»ºä¸€ä¸ªFork/Joinæ± </a></li>
<li><a href="http://ifeve.com/fork-join-3/">Fork/Joinæ¡†æ¶ï¼ˆä¸‰ï¼‰åŠ å…¥ä»»åŠ¡çš„ç»“æœ</a></li>
<li><a href="http://ifeve.com/fork-join-4/">Fork/Joinæ¡†æ¶ï¼ˆå››ï¼‰å¼‚æ­¥è¿è¡Œä»»åŠ¡</a></li>
<li><a href="http://ifeve.com/fork-join-5/">Fork/Joinæ¡†æ¶ï¼ˆäº”ï¼‰åœ¨ä»»åŠ¡ä¸­æŠ›å‡ºå¼‚å¸¸</a></li>
<li><a href="http://ifeve.com/fork-join-6/">Fork/Joinæ¡†æ¶ï¼ˆå…­ï¼‰å–æ¶ˆä»»åŠ¡</a></li>
</ul></li>
</ul>
</article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a href="https://github.com/hello-world-example/Java-Concurrent/commit/e4d1a3f085dbadfbe7897a1c2214c34822092cde" title='Last modified Feb 17, 2020 by æ¨å‡¯å½¬' target="_blank" rel="noopener">
      <img src="/Java-Concurrent/svg/calendar.svg" alt="Changed" /> Feb 17, 2020
    </a>
  </div>
  
  
  <div>
    <a href="https://github.com/hello-world-example/Java-Concurrent/edit/master/HuGo/content/docs/java.util.concurrent/ForkJoin.md" target="_blank" rel="noopener">
      <img src="/Java-Concurrent/svg/edit.svg" alt="Edit" /> Edit this page
    </a>
  </div>
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#forkjoin">ForkJoin</a>
<ul>
<li><a href="#ä¸-executor-çš„åŒºåˆ«">ä¸ Executor çš„åŒºåˆ«</a></li>
<li><a href="#æ ¸å¿ƒç±»">æ ¸å¿ƒç±»</a></li>
<li><a href="#ç¼–ç¨‹æµç¨‹">ç¼–ç¨‹æµç¨‹</a></li>
<li><a href="#parallelism">parallelism</a>
<ul>
<li><a href="#new-forkjoinpool-parallelism">new ForkJoinPool(parallelism)</a></li>
<li><a href="#new-forkjoinpool">new ForkJoinPool()</a></li>
<li><a href="#forkjoinpool-commonpool">ForkJoinPool.commonPool()</a></li>
</ul></li>
<li><a href="#å¸¸è§çš„-forkjoin-æ¡ˆä¾‹">å¸¸è§çš„ ForkJoin æ¡ˆä¾‹</a>
<ul>
<li><a href="#arrays-parallelsort">Arrays.parallelSort</a></li>
<li><a href="#stream-parallel">stream.parallel()</a></li>
</ul></li>
<li><a href="#read-more">Read More</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>
  
  
  
</body>

</html>
