<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unsafe | Java-Concurrent</title>


<link rel="stylesheet" href="/Java-Concurrent/book.min.79de1f7861b0c98f453c0a93bebf3608a280809e417787746c373699639900d7.css">




<link rel="icon" href="/Java-Concurrent/favicon.png" type="image/x-icon">


<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" style="display: none" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://hello-world-example.github.io/Java-Concurrent/">Java-Concurrent</a>
</h2>






    
  
  
  

  <style>
  nav ul a[href$="\2fJava-Concurrent\2f docs\2fsun.misc\2fUnsafe\2f "] {
      color: #004ed0;
  }
  </style>

<ul>
<li><strong>java.lang</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.lang/Thread/">Thread</a></li>
<li><a href="/Java-Concurrent/docs/java.lang/ThreadLocal/">ThreadLocal</a></li>
</ul></li>
<li><strong>sun.misc</strong>

<ul>
<li><a href="/Java-Concurrent/docs/sun.misc/Unsafe/">Unsafe</a></li>
</ul></li>
<li><strong>java.util.concurrent.locks</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/locks/LockSupport/">LockSupport</a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/locks/AbstractQueuedSynchronizer/">AbstractQueuedSynchronizer</a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/locks/ReentrantLock/">ReentrantLock</a></li>
<li><del><sup>[8]</sup>StampedLock</del></li>
</ul></li>
<li><strong>java.util.concurrent</strong>

<ul>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ExecutorService/">ExecutorService<sup>â™¨</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Future/">Future<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ExecutorCompletionService/">ExecutorCompletionService<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ForkJoin/"><sup>[7]</sup>ForkJoin<sup>â™¨</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CompletableFuture/"><sup>[8]</sup>CompletableFuture<sup>â¿</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CountDownLatch/">CountDownLatch <sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Semaphore/">Semaphore<sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/CyclicBarrier/">CyclicBarrier<sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/Phaser/"><sup>[7]</sup> <del>Phaser</del><sup>ğŸ”’</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/BlockingQueue/">BlockingQueue<sup>ğŸ“</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/ArrayBlockingQueue/">ArrayBlockingQueue<sup>ğŸ“</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/LinkedBlockingQueue/">LinkedBlockingQueue<sup>ğŸ“</sup></a></li>
<li><a href="/Java-Concurrent/docs/java.util.concurrent/PriorityBlockingQueue/">PriorityBlockingQueue<sup>ğŸ“</sup></a></li>
<li><em><a href="/Java-Concurrent/docs/java.util.concurrent/SynchronousQueue/">SynchronousQueue<sup>ğŸ“</sup></a></em></li>
<li><em><a href="/Java-Concurrent/docs/java.util.concurrent/Exchanger/"> Exchanger<sup>ğŸ“</sup></a></em></li>
</ul></li>
<li><strong>java.util.concurrent.atomic</strong>

<ul>
<li><del>AtomicLong</del></li>
<li><del><sup>[8]</sup>LongAdder</del></li>
</ul></li>
</ul>







</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/Java-Concurrent/svg/menu.svg" alt="Menu" />
  </label>
  <strong>Unsafe</strong>
</header>

      
<article class="markdown">

<h1 id="unsafe">Unsafe</h1>

<p><code>Unsafe</code> æ˜¯ Java ä¸­å¯ä»¥ç›´æ¥æ“ä½œå†…å­˜çš„å·¥å…·ï¼Œå±äº <code>sun.*</code> åŒ…ä¸‹çš„APIã€‚</p>

<blockquote>
<p><strong>ç›´æ¥æ“ä½œå†…å­˜æ˜¯å¾ˆå±é™©çš„ä¸€ä»¶äº‹ï¼Œä¸èƒ½é€šè¿‡Javaè™šæ‹Ÿæœºçš„åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œå†…å­˜é‡Šæ”¾ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„å†…å­˜æ³„æ¼å’Œæº¢å‡ºï¼Œå¹¶ä¸”Unsafeæ˜¯ä¸€ä¸ªå¹³å°ç›¸å…³çš„ç±»ï¼Œåœ¨å®é™…å¼€å‘ä¸­å»ºè®®ä¸è¦ç›´æ¥ä½¿ç”¨ã€‚</strong></p>
</blockquote>

<h1 id="è·å–-unsafe-ç±»å®ä¾‹">è·å– Unsafe ç±»å®ä¾‹</h1>

<p>JDK å¯¹è¿™ä¸ªç±»è¿›è¡Œäº†é™åˆ¶ï¼Œæˆ‘ä»¬ä¸èƒ½é€šè¿‡å¸¸è§„ <code>new</code> çš„æ–¹å¼å»è·å–è¯¥ç±»çš„å®ä¾‹ï¼Œä¹Ÿä¸èƒ½é€šè¿‡<code>Unsafe.getUnsafe()</code>è·å–</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Unsafe</span> {

    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">static</span> <span style="color:#66d9ef">final</span> <span style="color:#a6e22e">Unsafe</span> theUnsafe;
    ...
	<span style="color:#75715e">// ç§æœ‰æ„é€ æ–¹æ³•
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Unsafe</span>() {
    }

    <span style="color:#75715e">// ä¸æ˜¯ ç³»ç»Ÿ ClassLoader ä¼š æŠ›å‡º SecurityException å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">static</span> Unsafe <span style="color:#a6e22e">getUnsafe</span>() {
        Class <span style="color:#a6e22e">var0</span> <span style="color:#f92672">=</span> Reflection.<span style="color:#a6e22e">getCallerClass</span>();
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>VM.<span style="color:#a6e22e">isSystemDomainLoader</span>(var0.<span style="color:#a6e22e">getClassLoader</span>())) {
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> SecurityException(<span style="color:#e6db74">&#34;Unsafe&#34;</span>);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">return</span> theUnsafe;
        }
    }
    
    <span style="color:#66d9ef">static</span> {
        ...
        <span style="color:#75715e">// ä½†æ˜¯é™æ€ä»£ç å—åœ¨ ç±»åŠ è½½å ä¼šåœ¨å†…éƒ¨å®ä¾‹åŒ– è‡ªå·±
</span><span style="color:#75715e"></span>        theUnsafe <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Unsafe();
        ...
    }
}</code></pre></div>
<h2 id="é€šè¿‡åå°„-è·å–-unsafe-å®ä¾‹">é€šè¿‡åå°„ è·å– Unsafe å®ä¾‹</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Field <span style="color:#a6e22e">theUnsafeField</span> <span style="color:#f92672">=</span> Unsafe.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;theUnsafe&#34;</span>);
theUnsafeField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
Unsafe <span style="color:#a6e22e">unsafe</span> <span style="color:#f92672">=</span> (Unsafe) theUnsafeField.<span style="color:#a6e22e">get</span>(<span style="color:#66d9ef">null</span>);
System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(unsafe);</code></pre></div>
<h2 id="è®©-å¼•å¯¼ç±»åŠ è½½å™¨-åŠ è½½">è®© å¼•å¯¼ç±»åŠ è½½å™¨ åŠ è½½</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> <span style="color:#a6e22e">xyz</span>.<span style="color:#a6e22e">kail</span>.<span style="color:#a6e22e">javase</span>.<span style="color:#a6e22e">demo</span>;

<span style="color:#f92672">import</span> <span style="color:#a6e22e">sun</span>.<span style="color:#a6e22e">misc</span>.<span style="color:#a6e22e">Unsafe</span>;

<span style="color:#75715e">// ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ å¼•å¯¼ç±»è·¯å¾„
</span><span style="color:#75715e">// java -Xbootclasspath:$JAVA_HOME/jre/lib/rt.jar:. xyz.kail.javase.demo.Main
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">class</span> Main {
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String[] <span style="color:#a6e22e">args</span>) {
        Unsafe <span style="color:#a6e22e">unsafe</span> <span style="color:#f92672">=</span> Unsafe.<span style="color:#a6e22e">getUnsafe</span>();
        System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(unsafe);
    }
}</code></pre></div>
<h1 id="unsafe-api">Unsafe API</h1>

<h2 id="çº¿ç¨‹">â¤ çº¿ç¨‹</h2>

<p>Unsafeæä¾›çš„ <strong><code>park</code>ã€<code>unpark</code> æ˜¯æ•´ä¸ªJavaå¹¶å‘åŒ…çš„åŸºç¡€æ ¸å¿ƒæ“ä½œæ–¹æ³•ï¼Œå…¶è¢«å°è£…æˆçš„ <code>LockSupport</code> æœ¬è´¨æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨çš„ Unsafe</strong></p>

<ul>
<li><code>void park(boolean isAbsolute, long time);</code>  æŒ‚èµ·çº¿ç¨‹

<ul>
<li>isAbsolute æ˜¯å¦æ˜¯ç»å¯¹æ—¶é—´</li>
<li>true ç»å¯¹æ—¶é—´ï¼Œè¶…æ—¶æ—¶é—´å‚æ•°timeçš„å•ä½æ˜¯<strong>æ¯«ç§’</strong>ï¼Œä¸€èˆ¬ç”¨å½“å‰æ—¶é—´çš„æ¯«ç§’æ•°+è¶…æ—¶æ—¶é—´æ¯«ç§’æ•°ä½œä¸ºå‚æ•°</li>
<li>false ç›¸å¯¹æ—¶é—´ï¼Œè¶…æ—¶æ—¶é—´å‚æ•°timeçš„å•ä½æ˜¯<strong>çº³ç§’</strong>ï¼Œtimeä¸º0è¡¨ç¤ºä¸€ç›´é˜»å¡ï¼Œæ²¡æœ‰è¶…æ—¶æ—¶é—´</li>
</ul></li>
<li><code>void unpark(Object thread);</code> ç»ˆæ­¢ä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸</li>
</ul>

<h2 id="å­—æ®µ">â¤ å­—æ®µ</h2>

<ul>
<li><code>long objectFieldOffset(Field var1);</code> å¯¹è±¡å­—æ®µåç§»é‡</li>
<li><code>long staticFieldOffset(Field var1);</code> é™æ€å­—æ®µåç§»é‡</li>
<li><code>Object staticFieldBase(Field var1);</code> é™æ€å­—æ®µæ‰€å¯¹åº”çš„ç±»ï¼Œè¯»å†™é™æ€å­—æ®µéœ€è¦é€šè¿‡è¯¥APIè·å–ç±»</li>
</ul>

<h2 id="cas-æ“ä½œ-compareandswap">â¤ CAS æ“ä½œï¼ˆcompareAndSwapï¼‰</h2>

<ul>
<li>å‚æ•°

<ul>
<li>obj è¢«æ“ä½œçš„å¯¹è±¡</li>
<li>offset å¯¹è±¡å­—æ®µçš„åç§»</li>
<li>expected å½“å‰æœŸå¾…çš„å€¼</li>
<li>newValue æ–°å€¼</li>
</ul></li>

<li><p>å¦‚æœå½“å‰å€¼æ˜¯ expected åˆ™è®¾ç½®æ–°å€¼ newValue å¹¶è¿”å› trueï¼Œå¦åˆ™è¿”å›false</p></li>

<li><p>boolean compareAndSwapXxx(obj, offset, expected, newValue)</p>

<ul>
<li>boolean compareAndSwapObject(Object, long, Object, Object);</li>
<li>boolean compareAndSwapInt(Object, long, int, int);</li>
<li>boolean compareAndSwapLong(Object, long, long, long);</li>
</ul></li>

<li><p>getAndAddXxx(obj, offset, addValue)</p>

<ul>
<li>getAndAddInt()</li>
<li>getAndAddLong()</li>
</ul></li>

<li><p>getAndSetXxx(obj, offset, setValue)</p>

<ul>
<li>getAndAddInt()</li>
<li>getAndSetLong()</li>
<li>getAndSetObject()</li>
</ul></li>
</ul>

<h2 id="å†…å­˜ä¿¡æ¯">å†…å­˜ä¿¡æ¯</h2>

<ul>
<li><code>int addressSize();</code> æ“ä½œç³»ç»Ÿçš„ç›´æ¥å­—èŠ‚é•¿åº¦ï¼Œ32ä½æ˜¯4ï¼Œ64ä½æ˜¯8</li>
<li><code>int pageSize();</code> æ“ä½œç³»ç»Ÿçš„å†…å­˜é¡µå¤§å°ï¼Œè¿™ä¸ªå€¼æ°¸è¿œéƒ½æ˜¯2çš„å¹‚æ¬¡æ–¹<br /></li>
</ul>

<h2 id="ä¸è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºç±»å¯¹è±¡">ä¸è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºç±»å¯¹è±¡</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">native</span> Object <span style="color:#a6e22e">allocateInstance</span>(Class<span style="color:#f92672">&lt;?&gt;</span> clazz) <span style="color:#66d9ef">throws</span> <span style="color:#a6e22e">InstantiationException</span>;</code></pre></div>
<h2 id="å®šä¹‰ç±»">å®šä¹‰ç±»</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">native</span> Class<span style="color:#f92672">&lt;?&gt;</span> defineClass(String <span style="color:#a6e22e">className</span>, <span style="color:#66d9ef">byte</span>[] <span style="color:#a6e22e">b</span>, <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">offset</span>, <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">len</span>, 
                                   ClassLoader <span style="color:#a6e22e">loader</span>, ProtectionDomain <span style="color:#a6e22e">protectionDomain</span>);

<span style="color:#75715e">// å®šä¹‰ä¸€ä¸ªåŒ¿åç±»
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">native</span> Class<span style="color:#f92672">&lt;?&gt;</span> defineAnonymousClass(Class<span style="color:#f92672">&lt;?&gt;</span> targetClass, <span style="color:#66d9ef">byte</span>[] <span style="color:#a6e22e">classBytes</span>, 
                                            Object[] <span style="color:#a6e22e">cpPatches</span>);</code></pre></div>
<h2 id="æ•°ç»„">æ•°ç»„</h2>

<ul>
<li><code>int arrayBaseOffset(Class&lt;?&gt; arrayClass);</code> è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€<br /></li>
<li><code>int arrayIndexScale(Class&lt;?&gt; var1);</code> æ•°ç»„ä¸­ä¸€ä¸ªå…ƒç´ å æ®çš„å†…å­˜ç©ºé—´</li>
</ul>

<p><code>arrayBaseOffset</code>ä¸<code>arrayIndexScale</code>é…åˆä½¿ç”¨ï¼Œå¯å®šä½æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ åœ¨å†…å­˜ä¸­çš„ä½ç½® ï¼Œå¦‚ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// int base = Unsafe.ARRAY_INT_BASE_OFFSET
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">base</span> <span style="color:#f92672">=</span> unsafe.<span style="color:#a6e22e">arrayBaseOffset</span>(<span style="color:#66d9ef">int</span>[].<span style="color:#a6e22e">class</span>);
<span style="color:#75715e">// int scale = Unsafe.ARRAY_INT_INDEX_SCALE;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">scale</span> <span style="color:#f92672">=</span> unsafe.<span style="color:#a6e22e">arrayIndexScale</span>(<span style="color:#66d9ef">int</span>[].<span style="color:#a6e22e">class</span>);

<span style="color:#66d9ef">int</span>[] <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> {1, 2, 3};
unsafe.<span style="color:#a6e22e">putInt</span>(arr, (<span style="color:#66d9ef">long</span>) (base <span style="color:#f92672">+</span> scale <span style="color:#f92672">*</span> 2), 100);

<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> arr.<span style="color:#a6e22e">length</span>; i<span style="color:#f92672">++</span>) {
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">=</span> unsafe.<span style="color:#a6e22e">getInt</span>(arr, (<span style="color:#66d9ef">long</span>) (base <span style="color:#f92672">+</span> scale <span style="color:#f92672">*</span> i));
<span style="color:#75715e">// è¾“å‡ºï¼š 1 2 100 
</span><span style="color:#75715e"></span>System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">print</span>(v <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span>);</code></pre></div>
<h2 id="è¯»å†™å­—æ®µ">è¯»å†™å­—æ®µ</h2>

<ul>
<li><p><code>putXxx(long address, typeValue)</code></p></li>

<li><p><code>putXxx(Object obj, long offset, typeValue)</code></p></li>

<li><p><code>putXxxVolatile(Object obj, long offset, typeValue)</code> å®ç°äº†volatileè¯­ä¹‰çš„åŠ å¼ºç‰ˆçš„ putXxx æ–¹æ³•</p></li>

<li><p><code>putOrderedXxx(Object obj, long offset, typeValue)</code> volatile ä¼šåœ¨ä»ä¸»å†…å­˜è¯»å–ï¼ŒåŒæ—¶å†™çš„æ—¶å€™ä¼šå†™åˆ°ä¸»å†…å­˜ï¼ŒputOrderedXxx è¯»çš„è¯­ä¹‰è·Ÿvolatileä¸€æ ·ï¼Œä½†æ˜¯å†™çš„æ—¶å€™åªå†™å·¥ä½œå†…å­˜ï¼Œä¸å†™ä¸»å†…å­˜ï¼Œæ‰€ä»¥ä¸ä¿è¯ç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§</p></li>
</ul>

<blockquote>
<p>ç¼–è¯‘å™¨ä¼šåœ¨æ¯ä¸€ä¸ª volatile å†™æ“ä½œ<strong>å‰é¢</strong>æ’å…¥StoreStoreå†…å­˜å±éšœï¼Œåœ¨å†™æ“ä½œ<strong>åé¢</strong>æ’å…¥StoreLoadå†…å­˜å±éšœï¼ŒStoreStoreå†…å­˜å±éšœå¯ä»¥åœ¨volatileå†™ä¹‹å‰å°†å‰é¢çš„å…¶ä»–å†™åˆ·æ–°å›ä¸»å†…å­˜ä½¿å…¶å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼ŒStoreLoadå†…å­˜å±éšœä¸ä½†åŒ…å«äº†StoreStoreå±éšœçš„åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜èƒ½ç¦æ­¢å¯¹Volatileå˜é‡çš„å†™å’Œåé¢çš„Volatileå˜é‡è¯»æ“ä½œçš„é‡æ’åºï¼Œä»è€Œä¸ä½†èƒ½ä¿è¯å°†æœ¬æ¬¡volatileå†™å…¥æ“ä½œç«‹å³å›å†™åˆ°ä¸»å­˜ä½¿å…¶å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼Œè€Œä¸”è¿˜èƒ½ä¿è¯åé¢çš„è¯»å–æ“ä½œç«‹å³é‡æ–°ä»ä¸»å­˜ä¸­åŠ è½½ä»¥è·å–æœ€æ–°çš„å€¼ã€‚ä»è¿™ä¸¤ç§å±éšœå¯ä»¥çœ‹å‡ºï¼ŒStoreStoreå±éšœåªä¿è¯å†™å…¥çš„é¡ºåºæ‰§è¡Œï¼Œå¹¶ä¸”åªä¼šå°†å±éšœä¹‹å‰çš„å…¶ä»–å†™åˆ·æ–°åˆ°ä¸»å­˜ä½¿å…¶å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ï¼Œä½†æ˜¯ä¸ä¼šå°†æœ¬æ¬¡çš„validateå†™åˆ·æ–°åˆ°ä¸»å­˜ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯æœ¬æ¬¡volatileçš„å†™å…¥çš„ç«‹å³å¯è§æ€§ã€‚è€ŒStoreLoadå±éšœå°±èƒ½æ»¡è¶³æ‰€æœ‰çš„ç«‹å³å¯è§çš„è¦æ±‚ï¼Œä½†æ˜¯è¿™ä¹Ÿå¯¼è‡´äº†StoreLoadå±éšœçš„å·¨å¤§å¼€é”€å’Œæ€§èƒ½çš„æŸè€—ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬ç†è§£ä¸ºï¼šJavaç¼–è¯‘å™¨ä¼šåœ¨ putOrderedXxx æ–¹æ³•ç›¸åº”çš„æŒ‡ä»¤å‰é¢åŠ ä¸ŠStoreStoreæŒ‡ä»¤ï¼Œä»è€Œé¿å…å†™å…¥æ“ä½œçš„é‡æ’åºä½†æ˜¯å¹¶ä¸ä¿è¯æœ¬æ¬¡å†™å…¥å¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯æ–¹æ”¾åä¸­æºå¸¦æœ‰Orderedå­—æ ·çš„ä½“ç°å§</p>

<p>â€”â€”<a href="https://pzh9527.iteye.com/blog/2415123">Javaå¹¶å‘åŒ…åŸºç¡€å…ƒä»¶sun.misc.Unsafe</a></p>
</blockquote>

<ul>
<li><code>putXxx(long address)</code></li>
<li><code>getXxx(Object obj, long offset)</code></li>
<li><code>getXxxVolatile(Object obj, long offset)</code> å®ç°äº†volatileè¯­ä¹‰çš„åŠ å¼ºç‰ˆçš„ getXxx æ–¹æ³•</li>
</ul>

<blockquote>
<p>å‚æ•° offset é€šè¿‡ <code>objectFieldOffset(Field f)</code> å’Œ <code>staticFieldOffset(Field f)</code>  è·å–</p>
</blockquote>

<h2 id="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</h2>

<ul>
<li><code>long allocateMemory(long bytes)</code> ï¼š åˆ†é…æŒ‡å®šçš„å¤§å°çš„å†…å­˜ï¼Œè¿”å›å†…å­˜åœ°å€</li>
<li><code>void freeMemory(long address)</code>ï¼šé‡Šæ”¾ä¸€å—å†…å­˜ï¼Œå‚æ•°ä¸ºå†…å­˜åœ°å€</li>
<li><code>long reallocateMemory(long address, long bytes)</code> æ ¹æ®ç»™å®šçš„å†…å­˜åœ°å€addressï¼Œé‡æ–°åˆ†é…æŒ‡å®šå¤§å°çš„å†…å­˜</li>
</ul>

<h2 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ</h2>

<ul>
<li><code>void loadFence();</code> ï¼šè¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰ loadæ“ä½œï¼ˆè¯»ï¼‰ åœ¨å†…å­˜å±éšœä¹‹å‰å®Œæˆ</li>
<li><code>void storeFence();</code>ï¼šè¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰ storeæ“ä½œï¼ˆå†™ï¼‰ åœ¨å†…å­˜å±éšœä¹‹å‰å®Œæˆ</li>
<li><code>void fullFence();</code> ï¼šè¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰ loadã€storeæ“ä½œ åœ¨å†…å­˜å±éšœä¹‹å‰å®Œæˆ</li>
</ul>

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>

<ul>
<li><a href="https://pzh9527.iteye.com/blog/2415123">Javaå¹¶å‘åŒ…åŸºç¡€å…ƒä»¶sun.misc.Unsafe</a></li>
<li><a href="http://ifeve.com/sun-misc-unsafe/">Java Magic. Part 4: sun.misc.Unsafe</a></li>
<li><a href="http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/">Java Magic. Part 4: sun.misc.Unsafe</a></li>
</ul>
</article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a href="https://github.com/hello-world-example/Java-Concurrent/commit/492e3ef9b5e9ba3b6137a1294daf8228067d8ce1" title='Last modified Feb 16, 2020 by æ¨å‡¯å½¬' target="_blank" rel="noopener">
      <img src="/Java-Concurrent/svg/calendar.svg" alt="Changed" /> Feb 16, 2020
    </a>
  </div>
  
  
  <div>
    <a href="https://github.com/hello-world-example/Java-Concurrent/edit/master/HuGo/content/docs/sun.misc/Unsafe.md" target="_blank" rel="noopener">
      <img src="/Java-Concurrent/svg/edit.svg" alt="Edit" /> Edit this page
    </a>
  </div>
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#unsafe">Unsafe</a></li>
<li><a href="#è·å–-unsafe-ç±»å®ä¾‹">è·å– Unsafe ç±»å®ä¾‹</a>
<ul>
<li><a href="#é€šè¿‡åå°„-è·å–-unsafe-å®ä¾‹">é€šè¿‡åå°„ è·å– Unsafe å®ä¾‹</a></li>
<li><a href="#è®©-å¼•å¯¼ç±»åŠ è½½å™¨-åŠ è½½">è®© å¼•å¯¼ç±»åŠ è½½å™¨ åŠ è½½</a></li>
</ul></li>
<li><a href="#unsafe-api">Unsafe API</a>
<ul>
<li><a href="#çº¿ç¨‹">â¤ çº¿ç¨‹</a></li>
<li><a href="#å­—æ®µ">â¤ å­—æ®µ</a></li>
<li><a href="#cas-æ“ä½œ-compareandswap">â¤ CAS æ“ä½œï¼ˆcompareAndSwapï¼‰</a></li>
<li><a href="#å†…å­˜ä¿¡æ¯">å†…å­˜ä¿¡æ¯</a></li>
<li><a href="#ä¸è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºç±»å¯¹è±¡">ä¸è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºç±»å¯¹è±¡</a></li>
<li><a href="#å®šä¹‰ç±»">å®šä¹‰ç±»</a></li>
<li><a href="#æ•°ç»„">æ•°ç»„</a></li>
<li><a href="#è¯»å†™å­—æ®µ">è¯»å†™å­—æ®µ</a></li>
<li><a href="#å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</a></li>
<li><a href="#å†…å­˜å±éšœ">å†…å­˜å±éšœ</a></li>
</ul></li>
<li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
</ul>
</nav>
  </aside>



  </main>
  
  
  
</body>

</html>
